<!--
# (c) Copyright Jupyter Development Team
# (c) Copyright IBM Corp. 2015
-->
<link rel='import' href='../polymer/polymer.html'>
<script src="../threejs/build/three.js"></script>
<script src="globe/globe.js"></script>


<dom-module id="webgl-globe">
    <template>
        <style>
          :host {
            display: block;
            height: 100%;
            width: 100%;
          }
          #container canvas {
            position: relative !important;
          }
        </style>
        <div id="container"></div>
        <content></content>
    </template>
</dom-module>

<script>
    (function () {
        'use strict';

        Polymer({
            is: 'webgl-globe',
            properties: {
              data: {
                type: Array,
                observer: '_dataChanged'
              },
              dataUrl: String
            },

            DEFAULT_HEIGHT: 500,

            _readDataFromUrl: function(url) {
              if (this.globe) {
                var xhr = new XMLHttpRequest();
                xhr.open( 'GET', url, true );

                xhr.onreadystatechange = function() {
                    if ( xhr.readyState === 4 && xhr.status === 200 ) {
                      var data = JSON.parse( xhr.responseText );

                      this.globe.addData( data, {format: 'magnitude'} );

                      this.globe.createPoints();

                      this.globe.animate();
                    }
                }.bind(this);

                xhr.send( null );
              }
            },

            _dataChanged: function(newData) {
              if (!newData) { return; }
              
              if (this.dataUrl) { return; } // if dataUrl is provided, we ignore this data change

              if(this.globe) {
                var data = [];
                for ( var i = 0; i < newData.length; i ++ ) {
                  data = data.concat(newData[i]);
                }

                this.globe.addData( data, {format: 'magnitude'} );

                this.globe.createPoints();

                this.globe.animate();
              }
            },

            _onWindowResize: function() {
              if(this.globe) {
                var container = this.$.container;
                var newHeight = this.widthHeightRatio ? container.offsetWidth/this.widthHeightRatio : container.offsetWidth;
                this.widthHeightRatio = container.offsetWidth / newHeight;

                container.style.height = newHeight + "px";

                this.globe.onWindowResize();
              }
            },

            _getParentHeight: function() {
              if(this.parentNode && this.parentNode.offsetHeight > this.DEFAULT_HEIGHT) {
                return this.parentNode.offsetHeight;
              } else {
                return this.DEFAULT_HEIGHT;
              }
            },

            _getParentWidth: function(current) {
              if(this.parentNode && this.parentNode.offsetWidth) {
                return this.parentNode.offsetWidth;
              }
            },

            _setContainerSize: function() {
              var height = this._getParentHeight();
              var width = this._getParentWidth();
              this.widthHeightRatio = width/height;

              var container = this.$.container;
              container.style.height = height + "px";
            },

            ready: function() {
              var container = this.$.container;
              
              this._setContainerSize();

              // Make the globe
              this.globe = new DAT.Globe( container, {imgDir: this.resolveUrl('globe/')} );

              if (this.dataUrl) {
                this._readDataFromUrl(this.dataUrl);
              } else if (this.data) {
                this._dataChanged(this.data);
              }
            },

            attached: function() {
              this._resizer = this._onWindowResize.bind(this);
              window.addEventListener('resize', this._resizer);
            },

            detached: function() {
              window.removeEventListener('resize', this._resizer);
            }
        });
    })();
</script>
