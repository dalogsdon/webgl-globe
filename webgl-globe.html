<!--
# (c) Copyright Jupyter Development Team
# (c) Copyright IBM Corp. 2015
-->
<link rel='import' href='../polymer/polymer.html'>
<script src="../threejs/build/three.js"></script>
<script src="globe/globe.js"></script>


<dom-module id="webgl-globe">
    <template>
        <style>
          :host {
            display: block;
            height: 100%;
            width: 100%;
          }
          #container canvas {
            position: relative !important;
          }
        </style>
        <div id="container"></div>
        <content></content>
    </template>
</dom-module>

<script>
    (function () {
        'use strict';

        Polymer({
            is: 'webgl-globe',
            properties: {
              data: {
                type: Array,
                observer: '_dataChanged'
              },
              dataUrl: String
            },

            behaviors: [
              Polymer.IronResizableBehavior
            ],
            listeners: {
              'iron-resize': '_resizeGlobe'
            },

            DEFAULT_HEIGHT: 500,

            _readDataFromUrl: function(url) {
              if (this.globe) {
                var xhr = new XMLHttpRequest();
                xhr.open( 'GET', url, true );

                xhr.onreadystatechange = function() {
                    if ( xhr.readyState === 4 && xhr.status === 200 ) {
                      var data = JSON.parse( xhr.responseText );

                      this.globe.addData( data, {format: 'magnitude'} );

                      this.globe.createPoints();
                    }
                }.bind(this);

                xhr.send( null );
              }
            },

            _dataChanged: function(newData) {
              if (!newData) { return; }
              
              if (this.dataUrl) { return; } // if dataUrl is provided, we ignore this data change

              if (this.globe) {
                var data = [];
                for ( var i = 0; i < newData.length; i ++ ) {
                  data = data.concat(newData[i]);
                }

                if (this.globe.points) {
                    this.globe.scene.remove(this.globe.points);
                }

                this.globe.addData(data, {format: 'magnitude'});

                this.globe.createPoints();
              }
            },

            _resizeGlobe: function() {
              if(this.globe) {
                var container = this.$.container;
                var newHeight = container.offsetHeight;
                if (!newHeight || newHeight === 0) {
                  newHeight = this.widthHeightRatio ? container.offsetWidth/this.widthHeightRatio : this.DEFAULT_HEIGHT;
                }
                this.widthHeightRatio = container.offsetWidth / newHeight;

                container.style.height = newHeight + "px";

                this.globe.onWindowResize();
              }
            },

            _getParentHeight: function() {
              if(this.parentNode && this.parentNode.offsetHeight > this.DEFAULT_HEIGHT) {
                return this.parentNode.offsetHeight;
              } else {
                return this.DEFAULT_HEIGHT;
              }
            },

            _getParentWidth: function(current) {
              if(this.parentNode && this.parentNode.offsetWidth) {
                return this.parentNode.offsetWidth;
              }
            },

            _setContainerSize: function() {
              var height = this._getParentHeight();
              var width = this._getParentWidth();
              this.widthHeightRatio = width/height;

              var container = this.$.container;
              container.style.height = height + "px";
            },

            ready: function() {
              this.async(function(){
                var display = window.getComputedStyle(this).display;
                if (display === 'none' || document.readyState !== 'complete') {
                  this.async(this.ready, 200);
                } else {
                  var container = this.$.container;
              
                  this._setContainerSize();

                  // Make the globe
                  this.globe = new DAT.Globe( container, {imgDir: this.resolveUrl('globe/')} );

                  if (this.dataUrl) {
                    this._readDataFromUrl(this.dataUrl);
                  } else if (this.data) {
                    this._dataChanged(this.data);
                  }

                  this.globe.animate();
                }
              });
            }
        });
    })();
</script>
